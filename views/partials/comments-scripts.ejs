<script>
(function() {
  'use strict';

  //sample comments here
  let comments = [
    {
        "id": 1763469903498, // id using timestamp for simplicity
        "avatar": "https://i.pravatar.cc/150?img=3",
        "username": "Noah Jackson",
        "title": "ISFJ for sure!",
        "comment": "This is a sample comment. I really love this profile and think it is super accurate! came from my own experience as an ISFJ 5w1 Taurus. Highly recommend checking out the other profiles on this site as well!",
        "mbti": "ISFJ",
        "enneagram": "",
        "zodiac": "LIBRA",
        "love": 45,
        "is_loved_by_current_user": false,
    },
    {
        "id": 1763470002089,
        "avatar": "https://i.pravatar.cc/150?img=6",
        "username": "Miracle Stevey",
        "title": "ISFJ or ISTP",
        "comment": "I wonder if this profile could also fit ISTP types? I feel like there are some similarities between the two, especially when it comes to their analytical and strategic thinking. What do you all think?",
        "mbti": "ISFJ",
        "enneagram": "1_wing_3",
        "zodiac": "LIBRA",
        "love": 41,
        "is_loved_by_current_user": false,

    },
];

    // Submit button enabler components init state
    let sendButtonStatus = false;
    let commentTitleStatus = false;
    let commentBodyStatus = false;
    let mbtiStatus = false;
    let enneagramStatus = false;
    let zodiacStatus = false;
    
    const sortByMostLovedButton = document.getElementById("sortByMostLoved");
    const sortByDateButton = document.getElementById("sortByDate");

    document.addEventListener("DOMContentLoaded", () => {
    
    // Initial comments render
    renderComments(comments, "mostLoved");

    function renderComments(comm=comments, sortType="mostLoved") {
        const container = document.getElementById('comments-container');
        
        if(sortType === "mostLoved") {
            comm.sort((a, b) => b.love - a.love);
        } else if (sortType === "byDate") {
            comm.sort((a, b) => b.id - a.id);
        }
        
        container.innerHTML = comm.map(comment => {
            const enneagramDisplay = comment.enneagram.replace(
            /_wing_/g, 
            '<img src="/static/wing.png" alt="wing" class="wing-of-changes">'
            );
            
            return `
            <div class="profile-card comment-box row">
                <div class="row sqs-row">
                <div class="col sqs-col-sub-trait comment-box-avatar">
                    <img class="comment-profile-picture" src="${comment.avatar}" /> 
                </div>
                <div class="col sqs-col-sub-trait comment-box-username">
                    <span>${comment.username}</span>
                </div>
                </div>
                <div class="row">
                <div class="sqs-col-12 comment-box-title">
                    <p>
                        ${comment.title}
                    </p>
                </div>
                </div>
                <div class="row sqs-row">
                <div class="col sqs-col-comment">
                    ${comment.mbti !="" ? "<div class='rounded-button'>" + comment.mbti + "</div>" : ''}
                    ${comment.enneagram !="" ? "<div class='rounded-button'>" + enneagramDisplay + "</div>" : ''}
                    ${comment.zodiac !="" ? "<div class='rounded-button zodiac-sign'>" + comment.zodiac + "</div>" : ''}
                </div>
                </div>
                <div class="row">
                <div class="comment-box-body">
                    <p>
                        ${comment.comment}
                    </p>
                </div>
                </div>
            
                <!-- LOVE/VOTE BUTTON -->
                <div class="row sqs-row">
                <div class="col sqs-col-comment">
                    <ul class="comment-loves">
                        <li class="love-button">
                        <i class="material-icons love-icon love-icon-${comment.id}" data-id=${comment.id}>favorite</i>
                        </li>
                        <li class="love-count">
                        <span class="vote-count comment-id-${comment.id}">${comment.love}</span>
                        </li>
                    </ul> 
                </div>
                </div>
            </div>
        `}).join('');
    }

    //SORTING COMMENTS BY MOST LOVED
    document.getElementById("sortByMostLoved").addEventListener("click", function () {
        renderComments(comments, "mostLoved");
        sortByDateButton.classList.remove("sorting-button-active");
        sortByMostLovedButton.classList.add("sorting-button-active");
    });

    //SORTING COMMENTS BY DATE (since we use timestamp as ID, so just sort by ID)
    document.getElementById("sortByDate").addEventListener("click", function () {
        renderComments(comments, "byDate");
        sortByMostLovedButton.classList.remove("sorting-button-active");
        sortByDateButton.classList.add("sorting-button-active");
    });

    //FILTER BY PERSONALITY SYSTEMS
    const filterItems = document.querySelectorAll('.comment-filter li');
    filterItems.forEach(item => {
        item.addEventListener('click', () => {

            filterItems.forEach(i => i.classList.remove('active'));
            item.classList.add('active');

            const filterType = item.textContent.trim();
            let filteredComments = comments;

            if (filterType === 'MBTI') {
                filteredComments = comments.filter(c => c.mbti !== "");
            } else if (filterType === 'Enneagram') {
                filteredComments = comments.filter(c => c.enneagram !== "");
            } else if (filterType === 'Zodiac') {
                filteredComments = comments.filter(c => c.zodiac !== "");
            }

            renderComments(filteredComments, "mostLoved");
        });
    });

    // Handle love button clicks
    document.addEventListener("click", (e) => {
        if (e.target.classList.contains('love-icon')) {
            const id = parseInt(e.target.dataset.id);
            toggleLove(id);
        }
    });

    const lovedComments = new Set();
    function toggleLove(id) {
        const comment = comments.find(c => c.id === id);
        const isLoved = document.getElementsByClassName('love-icon-'+id)[0];

        if (!comment) return;
        
        if (lovedComments.has(id)) {
            // Already loved - unlove it
            comment.love--;
            lovedComments.delete(id);
            isLoved.classList.remove('loved');
        } else {
            // Not loved yet - love it
            comment.love++;
            lovedComments.add(id);
            isLoved.classList.add('loved');
        }
        
        document.querySelector('.comment-id-' + id).textContent = comment.love;
    }

    // MBTI Dropdown
    const mbtiButton = document.getElementById("mbtiButton");
    const mbtiMenu = document.getElementById("mbtiMenu");
    const mbtiHeader = document.getElementById("mbtiHeader");

    let mbtiStatus = false;

     mbtiButton.addEventListener("click", (e) => {
        e.preventDefault(); 
        e.stopPropagation()
        mbtiMenu.classList.toggle("open");
        enneagramMenu.classList.remove("open");
        zodiacMenu.classList.remove("open");
    });

    // When clicking an item in the dropdown
    mbtiMenu.addEventListener("click", function (e) {
        if (!e.target.classList.contains("dropdown-item")) return;

        const selected = e.target.textContent.trim();

        // Update status & header class
        if (selected !== "MBTI") {
            mbtiStatus = true;
            mbtiHeader.classList.add("new-attribute-active");
            mbtiHeader.classList.remove("new-attribute-passive");
        } else {
            mbtiStatus = false;
            mbtiHeader.classList.remove("new-attribute-active");
            mbtiHeader.classList.add("new-attribute-passive");
        }

        mbtiButton.textContent = selected;

        mbtiMenu.classList.remove("show");

        setSendButtonState();
    });
    
    // Enneagram Dropdown
    const enneagramButton = document.getElementById("enneagramButton");
    const enneagramMenu = document.getElementById("enneagramMenu");
    const enneagramHeader = document.getElementById("enneagramHeader"); 

    let enneagramStatus = false;

    enneagramButton.addEventListener("click", (e) => {
        e.preventDefault(); 
        e.stopPropagation()
        mbtiMenu.classList.remove("open");
        enneagramMenu.classList.toggle("open");
        zodiacMenu.classList.remove("open");
    });

    enneagramMenu.addEventListener("click", function (e) {
        if (!e.target.classList.contains("dropdown-item")) return;

        const selected = e.target.innerHTML .trim();

        // Update status & header class
        if (selected !== "Enneagram") {
            enneagramStatus = true;
            enneagramHeader.classList.add("new-attribute-active");
            enneagramHeader.classList.remove("new-attribute-passive");
        } else {
            enneagramStatus = false;
            enneagramHeader.classList.remove("new-attribute-active");
            enneagramHeader.classList.add("new-attribute-passive");
        }

        enneagramButton.innerHTML = selected;
        
        enneagramMenu.classList.remove("show");

        setSendButtonState();
    });
    
    // Zodiac Dropdown
    const zodiacButton = document.getElementById("zodiacButton");
    const zodiacMenu = document.getElementById("zodiacMenu");
    const zodiacHeader = document.getElementById("zodiacHeader"); 

    let zodiacStatus = false;

    zodiacButton.addEventListener("click", (e) => {
        e.preventDefault(); 
        e.stopPropagation()
        mbtiMenu.classList.remove("open");
        enneagramMenu.classList.remove("open");
        zodiacMenu.classList.toggle("open");
    });

    zodiacMenu.addEventListener("click", function (e) {
        if (!e.target.classList.contains("dropdown-item")) return;

        const selected = e.target.textContent.trim();

        // Update status & header class
        if (selected !== "Zodiac") {
            zodiacStatus = true;
            zodiacHeader.classList.add("new-attribute-active");
            zodiacHeader.classList.remove("new-attribute-passive");
        } else {
            zodiacStatus = false;
            zodiacHeader.classList.remove("new-attribute-active");
            zodiacHeader.classList.add("new-attribute-passive");
        }

        zodiacButton.textContent = selected;
        
        zodiacMenu.classList.remove("show");

        setSendButtonState();
    });
    

    //close all menu if clicked outside
    
    document.addEventListener("click", (e) => {
        mbtiMenu.classList.remove("open");
        enneagramMenu.classList.remove("open");
        zodiacMenu.classList.remove("open");
    });

     // comment title watcher
     document.getElementById("showNewCommentBox").addEventListener("click", function () {
        const newCommentBox = document.querySelector(".comment-box");
        newCommentBox.classList.toggle("hidden");

     });

    // comment title watcher
    document.getElementById("commentTitle").addEventListener("keyup", function () {
        const v = this.value.trim();
        if (v != "") {
            commentTitleStatus = true;
        } 
        setSendButtonState();
    });

    // comment body watcher
    document.getElementById("commentBody").addEventListener("keyup", function () {
        const v = this.value.trim();
        if (v != "") {
            commentBodyStatus = true;
        } 
        setSendButtonState();

    });

    function setSendButtonState() {
        // console.log(commentTitleStatus, commentBodyStatus, mbtiStatus, enneagramStatus, zodiacStatus);
        const sendButton = document.querySelector(".send-button");
        if (commentTitleStatus || commentBodyStatus || mbtiStatus || enneagramStatus || zodiacStatus ) {
            sendButton.classList.remove("disabled-button");
            sendButtonStatus = true;
        } else {
            sendButton.classList.add("disabled-button");
            sendButtonStatus = false;
        }
    }

    // === Form Submission ===
    const commentForm = document.getElementById('comment-form');
    const commentBox = document.querySelector('.comment-box');

    commentForm?.addEventListener('submit', (e) => {
        e.preventDefault();
        const mbtiSelected = document.querySelector('.mbti-button').textContent.trim()
        const enneagramSelected = document.querySelector('.enneagram-button').innerHTML.trim()
        const zodiacSelected = document.querySelector('.zodiac-button').textContent.trim();
        const formData = {
            id: Date.now(),
            avatar: "https://i.pravatar.cc/150?img=1",
            username: "Nilam Abey",
            title: e.target.title.value,
            mbti: mbtiSelected !== "MBTI" ? mbtiSelected : "",
            enneagram: enneagramSelected !== "Enneagram" ? enneagramSelected : "",
            zodiac: zodiacSelected !== "Zodiac" ? zodiacSelected : "",
            comment: e.target.comment.value,
            love: 0,
            is_loved_by_current_user: false,
        };
        addComment(formData);
        commentBox.classList.add("hidden"); // Hide comment box after submission
        // reset dropdown button
        document.querySelector('.mbti-button').textContent = "MBTI";
        document.querySelector('.enneagram-button').innerHTML = "Enneagram";
        document.querySelector('.zodiac-button').textContent = "Zodiac";
        // reset header class 
        mbtiHeader.classList.remove("new-attribute-active");
        mbtiHeader.classList.add("new-attribute-passive");  
        enneagramHeader.classList.remove("new-attribute-active");
        enneagramHeader.classList.add("new-attribute-passive"); 
        zodiacHeader.classList.remove("new-attribute-active");
        zodiacHeader.classList.add("new-attribute-passive");
        // reset status
        commentTitleStatus = false; 
        commentBodyStatus = false;
        mbtiStatus = false;
        enneagramStatus = false;
        zodiacStatus = false;
        setSendButtonState();
        // reset form
        e.target.reset();
    });

    function addComment(newComment) {
        comments.push(newComment);
        renderComments(); // Re-render comments
    }

    //END of DOMContentLoaded
    });


})();
</script>